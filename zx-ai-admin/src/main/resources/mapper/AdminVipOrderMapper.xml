<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zm.zx.admin.mapper.AdminVipOrderMapper">
    
    <!-- VipOrderVO 结果映射 -->
    <resultMap id="VipOrderVOMap" type="com.zm.zx.admin.model.vo.VipOrderVO">
        <id property="id" column="id"/>
        <result property="orderNo" column="order_no"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="packageType" column="package_type"/>
        <result property="packageName" column="package_name"/>
        <result property="vipName" column="package_name"/>
        <result property="duration" column="duration"/>
        <result property="originalAmount" column="price"/>
        <result property="discountAmount" column="discount_amount"/>
        <result property="payAmount" column="price"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="paymentMethodName" column="payment_method_name"/>
        <result property="status" column="status"/>
        <result property="statusName" column="status_name"/>
        <result property="alipayTradeNo" column="alipay_trade_no"/>
        <result property="payTime" column="pay_time"/>
        <result property="cancelTime" column="cancel_time"/>
        <result property="refundTime" column="refund_time"/>
        <result property="refundReason" column="refund_reason"/>
        <result property="createTime" column="create_time"/>
    </resultMap>
    
    <!-- 查询VIP订单列表 -->
    <select id="selectVipOrderList" resultMap="VipOrderVOMap">
        SELECT
            v.id,
            v.order_no,
            v.user_id,
            u.username,
            v.package_type,
            v.package_name,
            v.duration,
            v.price,
            0 AS discount_amount,
            CASE v.payment_method
                WHEN 1 THEN '余额支付'
                WHEN 2 THEN '支付宝支付'
                ELSE '未知'
            END AS payment_method_name,
            v.payment_method,
            v.status,
            CASE v.status
                WHEN 0 THEN '待支付'
                WHEN 1 THEN '已支付'
                WHEN 2 THEN '已取消'
                WHEN 3 THEN '已退款'
                ELSE '未知'
            END AS status_name,
            v.alipay_trade_no,
            v.pay_time,
            NULL AS cancel_time,
            NULL AS refund_time,
            NULL AS refund_reason,
            v.create_time
        FROM vip_order v
        LEFT JOIN user u ON v.user_id = u.id
        <where>
            <if test="dto.orderNo != null and dto.orderNo != ''">
                AND v.order_no LIKE CONCAT('%', #{dto.orderNo}, '%')
            </if>
            <if test="dto.userId != null">
                AND v.user_id = #{dto.userId}
            </if>
            <if test="dto.status != null">
                AND v.status = #{dto.status}
            </if>
        </where>
        ORDER BY v.create_time DESC
    </select>
    
    <!-- 根据ID查询VIP订单详情 -->
    <select id="selectVipOrderById" resultMap="VipOrderVOMap">
        SELECT
            v.id,
            v.order_no,
            v.user_id,
            u.username,
            v.package_type,
            v.package_name,
            v.duration,
            v.price,
            0 AS discount_amount,
            CASE v.payment_method
                WHEN 1 THEN '余额支付'
                WHEN 2 THEN '支付宝支付'
                ELSE '未知'
            END AS payment_method_name,
            v.payment_method,
            v.status,
            CASE v.status
                WHEN 0 THEN '待支付'
                WHEN 1 THEN '已支付'
                WHEN 2 THEN '已取消'
                WHEN 3 THEN '已退款'
                ELSE '未知'
            END AS status_name,
            v.alipay_trade_no,
            v.pay_time,
            NULL AS cancel_time,
            NULL AS refund_time,
            NULL AS refund_reason,
            v.create_time
        FROM vip_order v
        LEFT JOIN user u ON v.user_id = u.id
        WHERE v.id = #{id}
    </select>
    
    <!-- 删除VIP订单 -->
    <delete id="deleteVipOrderById">
        DELETE FROM vip_order WHERE id = #{id}
    </delete>
</mapper>

