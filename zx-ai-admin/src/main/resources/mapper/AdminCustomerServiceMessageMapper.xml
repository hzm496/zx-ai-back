<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zm.zx.admin.mapper.AdminCustomerServiceMessageMapper">

    <!-- 获取所有有消息的用户ID列表 -->
    <select id="getAllUserIds" resultType="java.lang.Long">
        SELECT DISTINCT user_id
        FROM customer_service_message
        ORDER BY user_id DESC
    </select>

    <!-- 获取用户的最后一条消息 -->
    <select id="getLastMessage" resultType="com.zm.zx.common.model.customer.po.CustomerServiceMessage">
        SELECT *
        FROM customer_service_message
        WHERE user_id = #{userId}
        ORDER BY create_time DESC
        LIMIT 1
    </select>

    <!-- 获取用户发送的未读消息数量（用户发给客服的，sender_type=1） -->
    <select id="getUnreadCountByUser" resultType="int">
        SELECT COUNT(*)
        FROM customer_service_message
        WHERE user_id = #{userId}
          AND sender_type = 1
          AND is_read = 0
    </select>

    <!-- 获取所有用户的未读消息总数（用户发给客服的，sender_type=1） -->
    <select id="getTotalUnreadCount" resultType="int">
        SELECT COUNT(*)
        FROM customer_service_message
        WHERE sender_type = 1
          AND is_read = 0
    </select>

    <!-- 标记指定用户发送的消息为已读（用户发给客服的，sender_type=1） -->
    <update id="markUserMessagesAsRead">
        UPDATE customer_service_message
        SET is_read = 1
        WHERE user_id = #{userId}
          AND sender_type = 1
          AND is_read = 0
    </update>

</mapper>

